{% extends "base.html" %} {% block title %}Todos{% endblock title %}
{% block content %}

<style>
    button{
        background: transparent;
        border: none;
    }
</style>

<p>
    <h1>Todo Lists</h1>
    <a class="create-link" href="{% url 'todo_create' %}">Create a new list</a>
</p>
{% if not lists %}
<h2>No Todo Lists Found</h2>
{% endif %}

{% for list in lists %}
<h2>
    {{ list.title }}
    <form action="{% url 'delete_todo_list' list.id %}" method="POST" style="display:inline;">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('Are You sure to remove the list?')">üóëÔ∏è</button>
    </form>
</h2>
    <div class="table-responsive shadow-lg border border-dark">
        <table class="col-12">
            <thead>
                <tr>
                    <th class="col-8">Title</th>
                    <th class="col-2 text-center">Status</th>
                    <th class="col-1">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for todo in list.todoitem_set.all %}
                    <tr>
                        <td>{{ todo.title }}</td>
                        <td class="text-center">
                            {% if todo.completed %}
                                <span class="badge badge-success">Completed</span>
                            {% else %}
                                <span class="badge badge-danger">Not Completed</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <form action="{% url 'change_todo_item_status' todo.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('Are You sure to change the components status?')">üîÑÔ∏è</button>
                            </form>
                            <form action="{% url 'delete_todo_item' todo.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('Are You sure to remove the component?')">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% comment %} TODO zrobiƒá ≈ºeby to nie wyglƒÖda≈Ço jak g√≥wno {% endcomment %}

    <div id="items-container-{{ list.id }}">
        <div class="item">
            <input type="text" class="" name="item_{{ list.id }}_title" placeholder="New TODO item title">
            <input type="hidden" name="item_{{ list.id }}_completed" value="false">
            <label>
                Completed? <input type="checkbox" name="item_{{ list.id }}_completed" value="true">
            </label>
            <button type="button" id="add-item-{{ list.id }}">‚ûï</button>
        </div>
    </div>
{% endfor %}
{% comment %} TODO PRZEROBIƒÜ TO, VIEWS I UIRL NA SYNCHRONICZNE {% endcomment %}
<script>
    document.querySelectorAll('[id^="add-item-"]').forEach(button => {
        button.addEventListener('click', function(){
            let listId = this.id.replace("add-item-", "");
            let container = document.getElementById(`items-container-${listId}`);
            let inputField = container.querySelector("input[name^='item_'][type='text']");
            let checkboxField = container.querySelector("input[type='checkbox']");

            let title = inputField.value.trim();
            let completed = checkboxField.checked;

            if (title === "") {
                alert("Item title cannot be empty!");
                return;
            }

            fetch("/add-item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),  // Pobieramy CSRF token
                },
                body: JSON.stringify({
                    list_id: listId,
                    title: title,
                    completed: completed
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dodajemy nowy wiersz do tabeli
                    let newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td>${data.title}</td>
                        <td class="text-center">
                            ${data.completed ? '<span class="badge badge-success">Completed</span>' : '<span class="badge badge-danger">Not Completed</span>'}
                        </td>
                        <td class="text-center">
                            <button onclick="changeStatus(${data.item_id})">üîÑÔ∏è</button>
                            <button onclick="deleteItem(${data.item_id})">üóëÔ∏è</button>
                        </td>
                    `;
                    container.closest(".table-responsive").querySelector("tbody").appendChild(newRow);

                    // Czy≈õcimy pole po dodaniu elementu
                    inputField.value = "";
                    checkboxField.checked = false;
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });

    // Funkcja do pobrania CSRF tokena z ciasteczka
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

</script>
{% endblock content %}
